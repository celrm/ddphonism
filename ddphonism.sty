% ddphonism
% 
% (c) Celia Rubio Madrigal
%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt.
 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ddphonism}
[2019/08/10 v0.1 LaTeX package for twelve-tone matrices, clock diagrams et al.]

\RequirePackage{ifthen}
\RequirePackage{xparse}
\RequirePackage{tikz}
\RequirePackage{xstring}
\RequirePackage{pgfkeys}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Matrices

\usetikzlibrary{matrix}

\ExplSyntaxOn
\DeclareExpandableDocumentCommand{\Evaluation}{m}{\int_eval:n {#1}}
\ExplSyntaxOff

\newcounter{Dsize}
\newcommand{\DsizeMake}[1]{%
	\setcounter{Dsize}{0}%
	\foreach \n in {#1}{%
		\stepcounter{Dsize}%
	}%
}

% Only with numbers.
\newcounter{Dfirst}
\newcommand{\DheadMake}[1]{%
	\setcounter{Dfirst}{-1}%
	\foreach \n in {#1}{%
		\ifnum\theDfirst=-1%
		\setcounter{Dfirst}{\n}%
		\fi%
	}%
}

% Only when DsizeMake is already done.
\newcounter{Dmod}
\newcommand{\Modulo}[1]{%
	\setcounter{Dmod}{#1}
	\loop%
	\ifnum\theDmod>\Evaluation{\theDsize-1}%		
		\setcounter{Dmod}{\Evaluation{\theDmod-\theDsize}}%
		\repeat%
	\ifnum\theDmod<0%
		\setcounter{Dmod}{\Evaluation{\theDmod+\theDsize}}%
		\repeat%
	\theDmod%
}

\newif\ifdmatrixLines
\newif\ifdmatrixOutside
\newif\ifdmatrixInside
\pgfkeys{
	/dmatrix/.is family
	, /dmatrix
	, default/.style = 
		{ lines = false
		, outside lines = false
		, inside lines = false
		, scale = 1
		}
	, lines/.is if=dmatrixLines
	, outside lines/.is if=dmatrixOutside
	, inside lines/.is if=dmatrixInside
	, scale/.estore in=\dmatrixScale
}

\newcommand{\DmatrixOutside}{%	
	\draw (0.05,0) -- (\theDsize+0.05,0);%
	\draw (0.05,-\theDsize*0.5) -- (\theDsize+0.05,-\theDsize*0.5);%
	\draw (0.05,0) -- (0.05,-\theDsize*0.5);%
	\draw (\theDsize+0.05,0) -- (\theDsize+0.05,-\theDsize*0.5);%
}

\newcommand{\DmatrixInside}{%
	\foreach \xD in {1,...,\Evaluation{\theDsize-1}} {%
		\draw (\xD+0.05,0) -- (\xD+0.05,-\theDsize*0.5);%
		\draw (0.05,-\xD*0.5) -- (\theDsize+0.05,-\xD*0.5);%
	}%
}

\newcommand{\dmatrix}[2][]{%
	\pgfkeys{/dmatrix, default, #1}%
	\DsizeMake{#2}%
	\DheadMake{#2}%
	\begin{tikzpicture}[scale=\dmatrixScale]%
		\foreach [count=\nj] \j in {#2} {%
			\foreach [count=\ni] \i in {#2} {%
				\draw node at (\ni-0.5,-\nj/2+0.25) {%
					\Modulo{\Evaluation{\i-\j+\theDfirst}}%
				};%
			}%
		}%
		\ifdmatrixLines%
			\DmatrixInside%
			\DmatrixOutside%
		\else%
			\ifdmatrixOutside%
				\DmatrixOutside%
			\fi%
			\ifdmatrixInside%
				\DmatrixInside%
			\fi%
		\fi%
	\end{tikzpicture}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Diagrams

\usetikzlibrary{shapes,arrows,decorations.markings,shapes.misc}

\tikzstyle ddiagramArrow=[decoration=
		{markings,mark=at position 0.25 with
			{\arrow[scale=1.25,>=triangle 45]{>}}},
	postaction={decorate}]

\newcounter{Dprev}
\newcounter{Dvar}

\newcommand{\ddiagram}[3][-1]{%
	\DsizeMake{#2}%
	\DheadMake{#2}%
	%
	\ifnum #1=-1%
	\setcounter{Dvar}{\theDfirst}%
	\else\setcounter{Dvar}{#1}%
	\fi%
	%
	\begin{tikzpicture}[rotate=360*\theDvar/\theDsize,%
	minimum height=0pt,inner sep=0pt,outer sep=0pt,scale=0.65]%
	\foreach \x in {0,...,\Evaluation{\theDsize-1}} {%
		\node at (90-360*\x/\theDsize:2) {\x};%
		\node (\x) at (90-360*\x/\theDsize:1.6) {};%
	};%
	%
	\setcounter{Dprev}{-1}%
	\foreach \x in {#2}{
		\ifnum \theDprev=\theDfirst
		\draw [style=ddiagramArrow] (\theDprev) -- (\x);
		\else \ifnum \theDprev=-1
		\else
		\draw (\theDprev) -- (\x);
		\fi\fi
		\setcounter{Dprev}{\x}
	};
	\draw (\theDprev) -- (\theDfirst);
	
	\node at (0,0) [circle,fill=white] {#3};%
	\end{tikzpicture}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dihedral diagrams

\tikzstyle ddihedralArrow=[decoration=
		{markings,mark=at position 1 with {\arrow[scale=1.5,>=angle 60]{>}}},
	postaction={decorate}]

\pgfkeys{
	/ddihedral/.is family, /ddihedral,
	default/.style = {t = 0, c = 0, s = 0, v = 0},
	t/.estore in = \ddihedralT,
	c/.estore in = \ddihedralC,
	s/.estore in = \ddihedralS,
	v/.estore in = \ddihedralV,
}

\newcommand{\darrows}[1]{%
	\DsizeMake{#1}%
	\draw foreach \x in {0,...,\Evaluation{\theDsize-1}} {%
		(90-360*\x/\theDsize:2.5) node[circle] (\x) {}%
	};%
	\foreach \x [count=\y] in {#1} {%
		\draw [style=ddihedralArrow] (90-360*\Evaluation{\y-1}/\theDsize:1.25) -- (\x);%
	};%
}

\newcommand\ddihedral[2][]{%
	\pgfkeys{/ddihedral, default, #1}%
	%
	\tikzset{inner sep=0,minimum height=18pt}%
	%
	\DsizeMake{#2}%
	%
	\draw foreach \x in {0,...,\Evaluation{\theDsize-1}} {%
		(\Evaluation{(90+\ddihedralT*360/\theDsize)+(2*\ddihedralS-1)*\x*360/\theDsize}:2.5)%
		node[very thin,circle,draw] (\x) {\x}%
	};%
	%
	\draw foreach \x in {0,...,\Evaluation{\theDsize-1}} {%
		(\Evaluation{(90-\ddihedralC*360/\theDsize)+(2*\ddihedralV-1)*\x*360/\theDsize}:1.25)%
		node[very thin,circle,draw] {\x}%
	};%
	%
	\darrows{#2}%
	%
	\node at (0,0) [very thin,draw,circle, fill=white] {\ %
		\ifnum\ddihedralV=0%
		\ifnum\ddihedralC=0%
		\ifnum\ddihedralS=0%
		\ifnum\ddihedralT=0%
		P%
		\fi\fi\fi%
		\else V \fi%
		\ifnum\ddihedralC=0%
		\else C$^{\ddihedralC}$ \fi%
		\ifnum\ddihedralS=0%
		\else S \fi%
		\ifnum\ddihedralT=0%
		\else T$^{\ddihedralT}$ \fi%
	\ };%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Rows

\long\def\addto#1#2{\expandafter\def\expandafter#1\expandafter{#1#2}}
\newcounter{myDDcntr}
	
\newcommand{\drow}[1]{%
	\DsizeMake{#1}%
	\ifnum\theDsize=0%
		\ensuremath{\left(\right)}%
	\else\ifnum\theDsize=1%
		\ensuremath{%
			\left(\begin{array}{*{\theDsize}c}%
				0\\%
				#1\\%
			\end{array}\right)%
		}%
	\else%
		\def\TableDDdata{}%
		\setcounter{myDDcntr}{0}%
		\loop%
			\addto\TableDDdata{\themyDDcntr\stepcounter{myDDcntr} &}%
			\stepcounter{myDDcntr}%
			\ifnum\themyDDcntr<\Evaluation{\theDsize-1}%
			\repeat%
		\addto\TableDDdata{\themyDDcntr \\}%
		\setcounter{myDDcntr}{0}%
		%
		\ensuremath{%
			\left(\begin{array}{*{\theDsize}c}%
				\TableDDdata%
				\StrSubstitute{#1}{,}{&}\\%
			\end{array}\right)%
		}%
	\fi\fi
}

\endinput


%% End of file `ddphonism.sty'.